# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**MikroNestForge** is a pnpm monorepo that provides CLI tools for generating NestJS DTOs, mappings, and resource scaffolding from MikroORM entities. The project uses pnpm workspaces and consists of two packages: `generator` (the core CLI tool) and `test-nest-app` (a test application demonstrating usage).

## Essential Commands

### Development & Testing Commands

```bash
# Build the generator package
pnpm -C packages/generator build

# Test generating DTOs from entities
pnpm -C packages/test-nest-app generate-dto

# Test generating resource scaffolding from entities
pnpm -C packages/test-nest-app generate-scaffold

# Build the test NestJS app
pnpm -C packages/test-nest-app build

```

### Code Quality

```bash
# Lint the test-nest-app
cd packages/test-nest-app && pnpm run lint

# Format code
cd packages/test-nest-app && pnpm run format
```

## High-Level Architecture

### Generator Pipeline
The system follows a modular generator pipeline: `Entity Files → Entity Registry → Generator Functions → Templates → Output Files`

### Key Components

1. **Entry Points**
   - `packages/generator/src/cli.ts` - Main MikroNestForge CLI with subcommands (generate-dto, update-mappings, generate-scaffold)
   - `packages/generator/src/resource-cli.ts` - Resource scaffolding generator CLI (called by generate-scaffold subcommand)

2. **Generator Types**
   - DTO Generators & Mapping Generators(`dto`,`create-dto`,`update-dto`,`find-many-dto`,`find-many-response-dto`,`entity-to-dto`, `create-dto-to-entity`, `update-dto-to-entity`,`find-many-to-filter`): these are always generated by the cli tool.users should not modify them manually.
   - Resource Generators: cli tools just generate a framework with basic crud. Users can then extend them on thier own.

3. **Entity Resolution System**
   - O(1) entity registry for relationship resolution
   - String-based caching for performance
   - Smart import resolution and dependency management

4. **Template System**
   - Handlebars-based templating with custom helpers
   - resource templates for NestJS components (controller, service, module)
   - Template utilities for case conversion and pluralization

### Configuration System

Configuration files are auto-detected in this priority order:
1. `mikro-nest-forge.config.ts`
2. `mikro-nest-forge.config.js`
3. `.mikro-nest-forge.config.ts`
4. `.mikro-nest-forge.config.js`

#### New Configuration Structure (v2.0+)

The configuration is organized into two main sections:

```typescript
import { MikroNestForgeConfig } from "@mikro-nest-forge/mikro-nest-forge";

const config = new MikroNestForgeConfig({
  // Settings for DTO and mapping function generation
  mappingGeneratorOptions: {
    entitiesGlob: "src/entities/**/*.ts",     // Glob pattern for entity files
    outputDir: "src/generated/mikro-nest-forge", // Output directory
    generators: [                             // Generators to run
      "dto", "create-dto", "update-dto",
      "find-many-dto", "find-many-response-dto",
      "entity-to-dto", "create-dto-to-entity",
      "update-dto-to-entity", "find-many-to-filter"
    ],
    performance: {
      enabled: true,      // Enable parallel processing
      workerCount: 4      // Number of concurrent workers
    }
  },
  // Settings for resource scaffolding
  scaffoldGeneratorOptions: {
    basePath: "src",
    templates: {
      entity: "entities/{dir}/{entity}.ts",
      controller: "user/{dir}/{entity}/{entity}.controller.ts",
      service: "user/{dir}/{entity}/{entity}.service.ts",
      module: "user/{dir}/{entity}/{entity}.module.ts"
    }
  }
});

export default config;
```

**Key Configuration Classes:**

- **`MikroNestForgeConfig`**: Root configuration
  - `mappingGeneratorOptions`: Settings for `generate-dto` and `update-mappings` commands
  - `scaffoldGeneratorOptions`: Settings for `generate-scaffold` command

- **`MappingGeneratorOptions`**: DTO and mapping generation settings
  - `entitiesGlob`: Glob pattern for entity files
  - `outputDir`: Output directory for generated files
  - `generators`: Array of generator types to run
  - `performance`: Parallelization settings

- **`PerformanceConfig`**: Performance settings
  - `enabled`: Enable/disable parallel processing
  - `workerCount`: Number of concurrent workers

- **`ScaffoldGeneratorOptions`**: Resource scaffolding settings
  - `basePath`: Base path for output files
  - `templates`: Template path patterns for generated files

**Note:** As of v3.0, only the `MikroNestForgeConfig` format is supported. The legacy `DtoGeneratorConfig` format has been completely removed. See [MIGRATION_GUIDE.md](./MIGRATION_GUIDE.md) for upgrade instructions.

### Entity-DTO Relationship

The system analyzes MikroORM entities decorated with `@Entity()` and generates corresponding DTOs with:
- Proper TypeScript types and nullability
- Swagger documentation via `@ApiProperty()`
- Validation decorators support
- Relationship mapping (OneToOne, OneToMany, ManyToOne, ManyToMany)
- Special handling for primary keys and enums

### Performance Features

- **Parallel Processing**: Entities processed in configurable batches with concurrent workers
- **Caching System**: String-based caching for relation resolution and entity registry
- **Memory Optimization**: Efficient entity lookups avoiding O(N*M) nested loops

### Error Handling

Custom error types with rich context:
- `DtoGeneratorError` - General generation errors
- `ConfigurationError` - Configuration validation errors
- `EntityResolutionError` - Entity relationship resolution errors

The system continues processing other entities when individual entities fail, providing comprehensive error reporting.

## Development Workflow

1. **Making Changes to Generator Logic**
   - Edit files in `packages/generator/src/`
   - Run `pnpm run build` in generator package
   - Test changes for dto/mapping generation using `pnpm -C packages/test-nest-app generate-dto`
   - Test changes for resource scaffolding generation using `cd packages/test-nest-app && rm -rf src/generated/{resource-path} && pnpm generate-scaffold -e src/entities/{entity-name}.ts -o src/generated`


## Important Notes

- This is a pnpm workspace - always use `pnpm` instead of `npm`
- Generated files are placed in `src/generated/mikro-nest-forge/` by default (configurable)
- The system uses ts-morph for TypeScript AST manipulation
- Handlebars is used for template-based code generation
- Configuration can be overridden via CLI arguments